---
# Deploy selected service using Docker on app-server
- name: Deploy {{ service }}
  hosts: app_servers
  become: true

  vars:
    # Port map - each service gets its own port
    service_port_map:
      service1: "8081"
      service2: "8082"

    # Resolve port based on selected service
    app_port: "{{ service_port_map[service] }}"

  tasks:
    # Pull the latest Docker image from DockerHub
    - name: Pull Docker image
      shell: docker pull {{ image_name }}

    # Stop existing container if running
    - name: Stop existing container
      shell: docker stop {{ service }} || true

    # Remove existing container
    - name: Remove existing container
      shell: docker rm {{ service }} || true

    # Run new container on the correct port
    - name: Run new container
      shell: docker run -d --name {{ service }} -p {{ app_port }}:80 {{ image_name }}
